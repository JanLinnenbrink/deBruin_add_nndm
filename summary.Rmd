---
title: "DeBruin Summary"
author: "Jonathan Bahlmann"
date: '2022-06-23'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r comment, echo=F, eval=F}
# knit to markdown:
  md_document:
    variant: markdown_github
```

# Adding NNDM to "Dealing with Clustered Samples ..."

1. Reproducing most of the existing methodology with 100 sampling realizations (100 in original study) of 700 points (5000) and 3 CV iterations (100).

2. Adding the NNDM CV method.

```{r, echo=F, warning=F, message=F}
library(sf)
library(raster)
library(ggplot2)
library(ggpubr)
```

## Sampling Designs
As a reminder: Plotting a randomly chosen sampling design example.

```{r, echo=F}
# par(mfrow=c(3,2))
# gdalwarp -tr 5000 5000 -r average agb.tif agb_resamples.tif
agb <- raster::raster("./data/agb_resampled.tif")
sample_plots <- lapply(list.files("./samples"), function(dir) {
  r <- floor(runif(1, 1, 100))
  # print(paste0(dir, ": plotting the ", r, "th sampling design."))
  samp_name <- paste0("./samples/", dir, "/", sprintf("%03d", r), "_coords", ".Rdata")
  load(samp_name)
  if(class(pts)[1] != "sf") {
    sample_df <- as.data.frame(pts)
    sample_sf <- st_as_sf(sample_df, coords = c("x", "y"))
    st_crs(sample_sf) <- st_crs(agb) # set crs EPSG:3035
  } else {
    sample_sf <- pts
  }
  
  agb_df <- as.data.frame(agb, xy=TRUE)
  
  m1 <- ggplot() + 
    geom_raster(data=agb_df, aes(x=x, y=y, fill=agb_resampled)) + 
    geom_sf(data=sample_sf, shape = 2, size = 0.1) + 
    theme_light() +
    scale_fill_gradientn(colours=terrain.colors(10), na.value="transparent") + #, na.value = "transparent") +
    ggtitle(dir)
  
  return(m1)
}) 

# raster::plot(agb, main = dir)
# plot(sample_sf, add=TRUE, pch=5, cex=0.1, color="black")
```

```{r, fig.width=12, fig.height=8, echo=F}
ggarrange(plotlist=sample_plots,
          ncol=3, nrow=2, common.legend = T)
```

## Gather Result Data

Gather data from their output folders into a dataframe.

```{r, eval=T}
# ************************************************************************
# ******************************* Figure 9 *******************************
# ************************************************************************
library(openxlsx)

infolder  <- "./CVresults"
outfolder <- "./material"

mets <- c("exhaustive", "random", "spatial", "intensity",
          "modelbased", "heteroscedastic", "nndm", "knndm", "bnndm")

colnms <- c("method", "variate", "design", "number", "RMSE", "MEC")
outtab <- data.frame(matrix(NA, 0, 10))
names(outtab) <- colnms

for(m in mets){
  p <- file.path(infolder, m)
  f_ins <- list.files(p, glob2rx("???_*.Rdata"))
  for(f_in in f_ins){
    lchar <- nchar(f_in)
    variate <- substr(f_in, 1, 3)
    design <- substr(f_in, 5, lchar-9)
    number <- as.numeric(substr(f_in, lchar-8, lchar-6))
    load(file.path(p, f_in))
    if(length(RMSE) > 1) {
      RMSE <- mean(RMSE)
    }
    if(m == "modelbased" | m == "heteroscedastic"){
      MEC    <- mean(MECs)
      RMSE   <- mean(RMSEs)
    } else{
      if(length(MEC) > 1){
        MEC  <- mean(MEC)
        RMSE <- mean(RMSE)
      }
    }
    
    newrow <- data.frame(method = m, variate = variate, design = design,
                         number = number, RMSE = RMSE, MEC = MEC)
    outtab <- rbind(outtab, newrow)
  }
}

write.xlsx(outtab, file.path(outfolder, "outtab100.xlsx"), overwrite = T)
```


```{r, eval=T}
ggplot(data=outtab[outtab$variate == "AGB",]) +
  geom_boxplot(aes(x=method, y=RMSE, color=design)) +
  ggtitle("AGB: RMSE by CV Method")

ggplot(data=outtab[outtab$variate == "OCS",]) +
  geom_boxplot(aes(x=method, y=RMSE, color=design)) +
  ggtitle("OCS: RMSE by CV Method")
```

```{r, eval=T}
mytab <- outtab
# mytab <- mytab[mytab$number < 6,]
mytab$rRMSE <- NA
mytab$rMEC  <- NA

numbers <- mytab[mytab$variate == "OCS" & mytab$method=="exhaustive" & mytab$design=="clusterGapped",]$number

mytab <- mytab[mytab$number %in% numbers, ]

for(variate in unique(mytab$variate)) {
  for (design in unique(mytab$design)) {
    for (number in unique(mytab$number)) {
      measurement <- which(mytab$variate==variate & mytab$design == design & mytab$number == number)
      validation <- which(mytab$variate==variate & mytab$design == design & mytab$number == number & mytab$method == "exhaustive")
      mytab$rRMSE[measurement] <- 100 * (mytab$RMSE[measurement] - mytab$RMSE[validation])/
        mytab$RMSE[validation]
      mytab$rMEC[measurement] <- 100 * (mytab$MEC[measurement] - mytab$MEC[validation])/
        mytab$MEC[validation]
    }
  }
}



# boxplot(rRMSE~method, data=mytab)

mytab$design[mytab$design == "clusterGapped"] <- "e_clusterGapped"
mytab$design[mytab$design == "simpleRandom"] <- "a_simpleRandom"
mytab$design[mytab$design == "regular"] <- "b_regular"
mytab$design[mytab$design == "clusterMedium"] <- "c_clusterMedium"
mytab$design[mytab$design == "clusterStrong"] <- "d_clusterStrong"

mytab$method[mytab$method == "exhaustive"] <- "a_exhaustive"
mytab$method[mytab$method == "random"] <- "b_random"
mytab$method[mytab$method == "spatial"] <- "c_spatial"
mytab$method[mytab$method == "intensity"] <- "d_intensity"
mytab$method[mytab$method == "modelbased"] <- "e_modelbased"
mytab$method[mytab$method == "heteroscedastic"] <- "f_heteroscedastic"
mytab$method[mytab$method == "nndm"] <- "g_nndm"
mytab$method[mytab$method == "knndm"] <- "h_knndm"
mytab$method[mytab$method == "bnndm"] <- "i_bnndm"



(p_r <- ggplot(data=dat) +
  geom_hline(yintercept = 0, size=0.5) +
    scale_x_discrete() +
    geom_vline(xintercept=c(1.5,2.5,3.5,4.5,5.5,6.5,7.5), linetype=2, alpha=0.5, color="grey60") +
  geom_boxplot(aes(x=method, y=rRMSE, color=design)) +
  ggtitle("AGB: relative RMSE (%) by CV Method") +
  theme_bw() +
  facet_wrap(~variate))

ggsave(file.path(outfolder, "plot_rmse.pdf"), p_r)


```

```{r, eval=T}
mytab <- outtab[outtab$variate == "OCS",]
# mytab <- mytab[mytab$number < 6,]
mytab$rRMSE <- NA
mytab$rMEC  <- NA

for (design in unique(mytab$design)) {
  for (number in c(1:85, 94:100)) {
    measurement <- which(mytab$design == design & mytab$number == number)
    validation <- which(mytab$design == design & mytab$number == number & mytab$method == "exhaustive")
    mytab$rRMSE[measurement] <- 100 * (mytab$RMSE[measurement] - mytab$RMSE[validation])/
        mytab$RMSE[validation]
    mytab$rMEC[measurement] <- 100 * (mytab$MEC[measurement] - mytab$MEC[validation])/
        mytab$MEC[validation]
  }
}

# boxplot(rRMSE~method, data=mytab)

mytab$design[mytab$design == "clusterGapped"] <- "e_clusterGapped"
mytab$design[mytab$design == "simpleRandom"] <- "a_simpleRandom"
mytab$design[mytab$design == "regular"] <- "b_regular"
mytab$design[mytab$design == "clusterMedium"] <- "c_clusterMedium"
mytab$design[mytab$design == "clusterStrong"] <- "d_clusterStrong"

mytab$method[mytab$method == "exhaustive"] <- "a_exhaustive"
mytab$method[mytab$method == "random"] <- "b_random"
mytab$method[mytab$method == "spatial"] <- "c_spatial"
mytab$method[mytab$method == "intensity"] <- "d_intensity"
mytab$method[mytab$method == "modelbased"] <- "e_modelbased"
mytab$method[mytab$method == "heteroscedastic"] <- "f_heteroscedastic"
mytab$method[mytab$method == "nndm"] <- "g_nndm"
mytab$method[mytab$method == "knndm"] <- "h_knndm"



levels(as.factor(mytab$design))

ggplot(data=mytab[mytab$method != "a_exhaustive",]) +
  geom_boxplot(aes(x=method, y=rRMSE, color=design)) +
  ggtitle("OCS: relative RMSE (%) by CV Method")
```

* nndm ohne phi aus CAST paket
